{% extends 'base.html' %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <i class="bi bi-people-fill text-primary"></i>
            إدارة المستخدمين والصلاحيات
        </h2>
        <div>
            <a href="{{ url_for('admin.create_user') }}" class="btn btn-primary me-2">
                <i class="bi bi-person-plus"></i> إنشاء مستخدم جديد
            </a>
            <a href="{{ url_for('admin.dashboard') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-right"></i> العودة للوحة التحكم
            </a>
        </div>
    </div>

    <!-- إحصائيات سريعة -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-primary text-white">
                <div class="card-body">
                    <h4 class="card-title">{{ users_count }}</h4>
                    <p class="card-text">إجمالي المستخدمين</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-success text-white">
                <div class="card-body">
                    <h4 class="card-title">{{ users|selectattr('role', 'equalto', 'student')|list|length }}</h4>
                    <p class="card-text">الطلاب</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-warning text-dark">
                <div class="card-body">
                    <h4 class="card-title">{{ users|selectattr('role', 'equalto', 'teacher')|list|length }}</h4>
                    <p class="card-text">المعلمين</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-info text-white">
                <div class="card-body">
                    <h4 class="card-title">{{ users|selectattr('role', 'equalto', 'admin')|list|length }}</h4>
                    <p class="card-text">المشرفين</p>
                </div>
            </div>
        </div>
    </div>

    <!-- فلترة وبحث -->
    <div class="card mb-4">
        <div class="card-header bg-light">
            <h5 class="mb-0"><i class="bi bi-funnel"></i> خيارات البحث والفلترة</h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <input type="text" id="searchInput" class="form-control" placeholder="ابحث باسم المستخدم أو البريد الإلكتروني...">
                </div>
                <div class="col-md-3">
                    <select id="roleFilter" class="form-select">
                        <option value="">جميع الصلاحيات</option>
                        <option value="student">طالب</option>
                        <option value="teacher">معلم</option>
                        <option value="admin">مشرف</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select id="classFilter" class="form-select">
                        <option value="">جميع الصفوف</option>
                        {% set classes = [] %}
                        {% for user in users %}
                            {% if user.class_name and user.class_name not in classes %}
                                {% set _ = classes.append(user.class_name) %}
                                <option value="{{ user.class_name }}">{{ user.class_name }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button id="resetFilters" class="btn btn-outline-secondary w-100">
                        <i class="bi bi-arrow-clockwise"></i> إعادة تعيين
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- جدول المستخدمين -->
    <div class="card shadow-lg">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0">
                <i class="bi bi-list-check"></i> قائمة المستخدمين
                <span class="badge bg-light text-dark ms-2" id="usersCountBadge">{{ users_count }}</span>
            </h5>
        </div>
        <div class="card-body">
            {% if users %}
            <div class="table-responsive">
                <table class="table table-hover table-striped" id="usersTable">
                    <thead class="table-primary">
                        <tr>
                            <th>#</th>
                            <th>اسم المستخدم</th>
                            <th>البريد الإلكتروني</th>
                            <th>الصلة</th>
                            <th>الصف</th>
                            <th>الأنشطة</th>
                            <th>الحالة</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr data-role="{{ user.role }}" data-class="{{ user.class_name }}">
                            <td>{{ loop.index }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="user-avatar me-2">
                                        <i class="bi bi-person-circle fs-4 text-{{ 'primary' if user.role == 'admin' else 'success' if user.role == 'teacher' else 'info' }}"></i>
                                    </div>
                                    <div>
                                        <strong>{{ user.username }}</strong>
                                        {% if user.id == current_user.id %}
                                            <span class="badge bg-warning ms-1">أنت</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <a href="mailto:{{ user.email }}" class="text-decoration-none">
                                    <i class="bi bi-envelope me-1"></i>{{ user.email }}
                                </a>
                            </td>
                            <td>
                                <span class="badge bg-{{ 'primary' if user.role == 'admin' else 'success' if user.role == 'teacher' else 'info' }}">
                                    <i class="bi bi-{{ 'person-gear' if user.role == 'admin' else 'person-check' if user.role == 'teacher' else 'person' }} me-1"></i>
                                    {{ 'مشرف' if user.role == 'admin' else 'معلم' if user.role == 'teacher' else 'طالب' }}
                                </span>
                            </td>
                            <td>
                                {% if user.class_name and user.class_name != 'غير محدد' %}
                                    <span class="badge bg-secondary">{{ user.class_name }}</span>
                                {% else %}
                                    <span class="text-muted">غير محدد</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="activity-stats">
                                    <small class="text-muted d-block">
                                        <i class="bi bi-file-text me-1"></i> اختبارات: {{ user.created_exams }}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="bi bi-journal me-1"></i> واجبات: {{ user.created_assignments }}
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="bi bi-graph-up me-1"></i> نتائج: {{ user.exam_results }}
                                    </small>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-success">
                                    <i class="bi bi-check-circle me-1"></i> نشط
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <!-- زر إعادة تعيين كلمة المرور -->
                                    <button type="button" class="btn btn-outline-warning" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#resetPasswordModal"
                                            data-user-id="{{ user.id }}"
                                            data-user-name="{{ user.username }}"
                                            title="إعادة تعيين كلمة المرور">
                                        <i class="bi bi-key"></i>
                                    </button>
                                    
                                    <!-- زر تعديل المستخدم -->
                                    <button type="button" class="btn btn-outline-primary"
                                            onclick="editUser({{ user.id }})"
                                            title="تعديل المستخدم">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    
                                    <!-- زر حذف المستخدم -->
                                    {% if user.id != current_user.id %}
                                    <form action="{{ url_for('admin.delete_user', user_id=user.id) }}" 
                                          method="POST" 
                                          class="d-inline"
                                          onsubmit="return confirm('هل أنت متأكد من حذف المستخدم {{ user.username }}؟');">
                                        <button type="submit" class="btn btn-outline-danger" title="حذف المستخدم">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                    {% else %}
                                    <button class="btn btn-outline-secondary" disabled title="لا يمكن حذف حسابك">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle fs-4"></i>
                <h5>لا يوجد مستخدمون مسجلون في النظام</h5>
                <p class="mb-0">يمكنك البدء بإضافة مستخدمين جدد من خلال الزر أعلاه.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- معلومات الألوان والإرشادات -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <h6><i class="bi bi-info-circle text-primary me-2"></i>معلومات الألوان:</h6>
                    <div class="d-flex flex-wrap gap-2">
                        <span class="badge bg-primary">مشرف</span>
                        <span class="badge bg-success">معلم</span>
                        <span class="badge bg-info">طالب</span>
                        <span class="badge bg-warning">أنت</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card border-0 bg-light">
                <div class="card-body">
                    <h6><i class="bi bi-shield-check text-success me-2"></i>إرشادات الأمان:</h6>
                    <small class="text-muted">
                        • كلمات المرور مشفرة ولا يمكن عرضها<br>
                        • يمكن إعادة تعيين كلمات المرور عند الحاجة<br>
                        • احرص على تحديث الصلاحيات بانتظام
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal إعادة تعيين كلمة المرور -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="bi bi-key"></i> إعادة تعيين كلمة المرور
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="resetPasswordForm" method="POST" action="{{ url_for('admin.reset_user_password') }}">

                <div class="modal-body">
                    {{ form.hidden_tag() }}  <!-- أضف هذا السطر -->
                    <input type="hidden" id="resetUserId" name="user_id">
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">كلمة المرور الجديدة</label>
                        <input type="password" class="form-control" id="newPassword" name="new_password" 
                               placeholder="أدخل كلمة المرور الجديدة" required minlength="6">
                        <div class="form-text">يجب أن تكون كلمة المرور 6 أحرف على الأقل</div>
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">تأكيد كلمة المرور</label>
                        <input type="password" class="form-control" id="confirmPassword" name="confirm_password"
                               placeholder="أعد إدخال كلمة المرور الجديدة" required minlength="6">
                    </div>
                    <div class="alert alert-info">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            سيتم تطبيق كلمة المرور الجديدة فوراً على حساب المستخدم.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-warning">
                        <i class="bi bi-check-circle"></i> تأكيد إعادة التعيين
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal تحرير المستخدم -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-pencil"></i> تعديل بيانات المستخدم
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm" method="POST">
                <div class="modal-body">
                    <input type="hidden" id="editUserId" name="user_id">
                    <div class="mb-3">
                        <label for="editUsername" class="form-label">اسم المستخدم</label>
                        <input type="text" class="form-control" id="editUsername" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="editEmail" class="form-label">البريد الإلكتروني</label>
                        <input type="email" class="form-control" id="editEmail" name="email" required>
                    </div>
                    <div class="mb-3">
                        <label for="editRole" class="form-label">الدور</label>
                        <select class="form-select" id="editRole" name="role" required>
                            <option value="student">طالب</option>
                            <option value="teacher">معلم</option>
                            <option value="admin">مشرف</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-check-circle"></i> حفظ التعديلات
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// فلترة الجدول
function filterTable() {
    const searchText = document.getElementById('searchInput').value.toLowerCase();
    const roleFilter = document.getElementById('roleFilter').value;
    const classFilter = document.getElementById('classFilter').value;
    
    const rows = document.querySelectorAll('#usersTable tbody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const username = row.cells[1].textContent.toLowerCase();
        const email = row.cells[2].textContent.toLowerCase();
        const role = row.getAttribute('data-role');
        const userClass = row.getAttribute('data-class');
        
        const matchesSearch = username.includes(searchText) || email.includes(searchText);
        const matchesRole = !roleFilter || role === roleFilter;
        const matchesClass = !classFilter || userClass === classFilter;
        
        if (matchesSearch && matchesRole && matchesClass) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    // تحديث العداد
    document.getElementById('usersCountBadge').textContent = visibleCount;
}

// إعداد Modal إعادة تعيين كلمة المرور
document.getElementById('resetPasswordModal').addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const userId = button.getAttribute('data-user-id');
    const userName = button.getAttribute('data-user-name');
    
    document.getElementById('resetUserId').value = userId;
    document.querySelector('#resetPasswordModal .modal-title').innerHTML = 
        `<i class="bi bi-key"></i> إعادة تعيين كلمة المرور - ${userName}`;
    
    // تنظيف الحقول عند فتح المودال
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
});

// التحقق من كلمات المرور قبل الإرسال
document.getElementById('resetPasswordForm').addEventListener('submit', function(event) {
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (newPassword !== confirmPassword) {
        event.preventDefault();
        alert('كلمتا المرور غير متطابقتين!');
        document.getElementById('newPassword').focus();
        return false;
    }
    
    if (newPassword.length < 6) {
        event.preventDefault();
        alert('كلمة المرور يجب أن تكون 6 أحرف على الأقل!');
        document.getElementById('newPassword').focus();
        return false;
    }
    
    // إظهار رسالة تأكيد
    const userName = document.querySelector('#resetPasswordModal .modal-title').textContent.replace('إعادة تعيين كلمة المرور - ', '');
    if (!confirm(`هل أنت متأكد من إعادة تعيين كلمة مرور المستخدم "${userName}"؟`)) {
        event.preventDefault();
        return false;
    }
    
    return true;
});

// تعديل المستخدم
function editUser(userId) {
    // في الواقع، يجب جلب بيانات المستخدم من الخادم
    // هذا مثال توضيحي فقط
    const userRow = document.querySelector(`tr[data-user-id="${userId}"]`);
    if (userRow) {
        const username = userRow.cells[1].querySelector('strong').textContent;
        const email = userRow.cells[2].querySelector('a').textContent;
        const role = userRow.getAttribute('data-role');
        
        document.getElementById('editUserId').value = userId;
        document.getElementById('editUsername').value = username;
        document.getElementById('editEmail').value = email;
        document.getElementById('editRole').value = role;
        
        // إظهار Modal التعديل
        const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
        editModal.show();
    } else {
        alert('لم يتم العثور على بيانات المستخدم');
    }
}

// معالجة نموذج تعديل المستخدم
document.getElementById('editUserForm').addEventListener('submit', function(event) {
    event.preventDefault();
    
    const userId = document.getElementById('editUserId').value;
    const username = document.getElementById('editUsername').value;
    const email = document.getElementById('editEmail').value;
    const role = document.getElementById('editRole').value;
    
    // هنا سيتم إرسال البيانات إلى الخادم
    alert(`سيتم تحديث بيانات المستخدم:\n\nID: ${userId}\nالاسم: ${username}\nالبريد: ${email}\nالدور: ${role}`);
    
    // إغلاق Modal بعد الإرسال
    const editModal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
    editModal.hide();
});

// إعادة تعيين الفلاتر
document.getElementById('resetFilters').addEventListener('click', function() {
    document.getElementById('searchInput').value = '';
    document.getElementById('roleFilter').value = '';
    document.getElementById('classFilter').value = '';
    filterTable();
});

// إضافة معالجات الأحداث للبحث والفلترة
document.getElementById('searchInput').addEventListener('input', filterTable);
document.getElementById('roleFilter').addEventListener('change', filterTable);
document.getElementById('classFilter').addEventListener('change', filterTable);

// التهيئة الأولية
document.addEventListener('DOMContentLoaded', function() {
    filterTable();
    
    // إضافة تأثيرات للجدول
    const tableRows = document.querySelectorAll('#usersTable tbody tr');
    tableRows.forEach(row => {
        row.setAttribute('data-user-id', row.querySelector('[data-user-id]') ? 
            row.querySelector('[data-user-id]').getAttribute('data-user-id') : '');
        
        row.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(5px)';
            this.style.transition = 'all 0.3s ease';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(0)';
        });
    });
});

// عرض رسائل الـ Flash تلقائياً
document.addEventListener('DOMContentLoaded', function() {
    // البحث عن أي رسائل flash وعرضها
    const flashMessages = document.querySelectorAll('.alert');
    flashMessages.forEach(alert => {
        setTimeout(() => {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }, 5000);
    });
});
</script>

<style>
.user-avatar {
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.activity-stats small {
    font-size: 0.75rem;
}

.table td {
    vertical-align: middle;
}

.btn-group .btn {
    border-radius: 0.375rem !important;
    margin: 0 2px;
}

/* تأثيرات عند التمرير */
.table-hover tbody tr {
    transition: all 0.3s ease;
}

.table-hover tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.1) !important;
    transform: translateX(5px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* تخصيص شريط التمرير للجدول */
.table-responsive::-webkit-scrollbar {
    height: 8px;
}

.table-responsive::-webkit-scrollbar-track {
    background: #f1f1f1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb {
    background: #c1c1c1;
    border-radius: 4px;
}

.table-responsive::-webkit-scrollbar-thumb:hover {
    background: #a8a8a8;
}

/* تنسيق البطاقات الإحصائية */
.card.text-center .card-title {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 0.5rem;
}

.card.text-center .card-text {
    font-size: 0.9rem;
    opacity: 0.9;
}

/* تحسين مظهر الأزرار */
.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

/* تنسيق الـ badges */
.badge {
    font-size: 0.75em;
    font-weight: 500;
}

/* تحسين استجابة الجدول للشاشات الصغيرة */
@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .btn-group .btn {
        margin: 1px;
        padding: 0.2rem 0.4rem;
    }
    
    .activity-stats small {
        font-size: 0.7rem;
    }
}
</style>
{% endblock %}